<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能问答助手</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.2.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
        }

        /* 主容器 */
        .chat-container {
            max-width: 100%;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: row;
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* 添加左侧内容区域容器 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
            height: 100vh;
            position: relative;
        }

        /* 顶部导航 */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            padding: 0.5rem 2rem;
            box-shadow: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }

        .navbar-brand {
            font-size: 1.1rem;
            font-weight: bold;
            color: #000000;
            margin-left: 0;
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
        }

        .settings-btn {
            background: none;
            border: 1px solid #e5e7eb;
            border-radius: 0.4rem;
            cursor: pointer;
            padding: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            opacity: 0.6;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            box-shadow: none;
        }

        .settings-btn:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.03);
            transform: none;
            box-shadow: none;
        }

        .settings-btn svg {
            width: 16px;
            height: 16px;
            stroke-width: 1.5;
        }

        /* 深色模式适配 */
        body.dark-mode .settings-btn {
            color: #fff;
            border-color: #404040;
        }

        body.dark-mode .settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 聊天区域 */
        .chat-area {
            margin-top: 60px;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            overflow-y: auto;
            padding: 1rem 0;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            max-width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            animation: fadeIn 0.3s ease-in;
            font-size: 0.9rem;
            margin: 0.3rem 0;
            word-break: break-word;
            white-space: pre-wrap;
            border: none;
            margin-left: 1rem;
            margin-right: 1rem;
        }

        .user-message {
            align-self: flex-end;
            background-color: transparent;
            color: #333;
            border: none;
        }

        .bot-message {
            align-self: flex-start;
            background-color: transparent;
            border: none;
        }

        /* 输入区域 */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            max-width: calc(100% - 2rem);
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            border-top: none;
        }

        .input-container {
            width: 100%;
            display: flex;
            gap: 0.5rem;
            padding: 0;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 4rem 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 1.5rem;
            resize: none;
            min-height: 44px;
            max-height: 200px;
            font-size: 0.9rem;
            background: transparent;
            position: relative;
            line-height: 1.4;
            color: #333;
        }

        .message-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .message-input::placeholder {
            color: #9ca3af;
        }

        .send-btn {
            position: absolute;
            right: 32px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
            height: 24px;
            line-height: 24px;
        }

        .send-btn:hover {
            color: #000;
        }

        .send-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #666;
            background-color: transparent;
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }

            .chat-area {
                padding: 1rem;
            }
        }

        /* 深色模式样 */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .navbar,
        body.dark-mode .input-area,
        body.dark-mode .bot-message {
            background-color: rgba(26, 26, 26, 0.8);
            border-color: rgba(64, 64, 64, 0.5);
        }

        body.dark-mode .message-input {
            border-color: #4b5563;
            color: #e0e0e0;
        }

        body.dark-mode .message-input:focus {
            border-color: #3b82f6;
        }

        body.dark-mode .message-input::placeholder {
            color: #6b7280;
        }

        /* 加载动画 */
        .typing-indicator {
            display: flex;
            padding: 0.5rem 0.75rem;
            background-color: transparent;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background-color: #666;
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }

        body.dark-mode .typing-dot {
            background-color: #999;
        }

        body.dark-mode .typing-indicator span {
            color: #999;
        }

        /* 代码块样式 */
        .message pre {
            background-color: #f6f8fa;
            border-radius: 0.3rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.5rem 0;
            font-size: 0.85rem;
            max-width: 100%;
        }

        body.dark-mode .message pre {
            background-color: #2d2d2d;
        }

        /* 错误提示样式 */
        .error-message {
            background-color: #fee2e2;
            color: #dc2626;
            padding: 0.3rem;
            border-radius: 0.3rem;
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }

        body.dark-mode .error-message {
            background-color: #451a1a;
            color: #f87171;
        }

        /* 复制按钮样式 */
        .copy-btn {
            position: static;
            right: auto;
            top: auto;
            padding: 0.2rem 0.4rem;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.7rem;
            margin-top: 0.5rem;
            opacity: 1;
        }

        .message:hover .copy-btn {
            opacity: 1;
        }

        body.dark-mode .copy-btn {
            background: #404040;
            border-color: #505050;
            color: #e0e0e0;
        }

        /* 代码块容器样式优化 */
        .code-container {
            position: relative;
            margin: 0.75rem 0;
            width: 100%;
            overflow-x: auto;
        }

        /* 发送按钮状态 */
        .send-btn:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        /* 优化错误提示样式 */
        .error-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-icon {
            font-size: 1rem;
        }

        /* Toast 提示样式 */
        .toast {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        /* 导航栏按钮组样式 */
        .nav-buttons {
            display: flex;
            gap: 0.3rem;
            margin-right: 0;
        }

        /* 历史记录侧边栏样式 */
        .history-sidebar {
            position: fixed;
            top: 60px;
            right: 0;
            width: 240px;
            height: calc(100vh - 60px);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: none;
            flex-direction: column;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.2s ease;
            border-left: 1px solid rgba(229, 231, 235, 0.5);
        }

        .history-sidebar.active {
            display: flex;
            transform: translateX(0);  /* 显示时滑入 */
        }

        /* 移除历史记录切换按钮 */
        .toggle-history {
            display: none;
        }

        /* 历史记录头部样式 */
        .history-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 清空按钮样式 */
        .clear-history-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            color: #666;
            background: transparent;
            border: 1px solid #e5e7eb;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
            background-color: rgba(220, 38, 38, 0.05);
        }

        /* 历史记录样式优化 */
        .history-item {
            padding: 0.6rem 0.75rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.4rem;
            background-color: transparent;
            border: 1px solid rgba(229, 231, 235, 0.5);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .history-item:hover {
            transform: translateX(-5px);
            border-color: #2563eb;
            color: #2563eb;
        }

        /* 深色模式适配 */
        body.dark-mode .history-sidebar {
            background-color: rgba(26, 26, 26, 0.95);
            border-color: rgba(64, 64, 64, 0.5);
        }

        body.dark-mode .clear-history-btn {
            color: #999;
            border-color: #404040;
        }

        body.dark-mode .clear-history-btn:hover {
            color: #f87171;
            border-color: #f87171;
            background-color: rgba(248, 113, 113, 0.05);
        }

        body.dark-mode .history-item {
            border-color: rgba(64, 64, 64, 0.5);
            color: #999;
        }

        body.dark-mode .history-item:hover {
            border-color: #93c5fd;
            color: #93c5fd;
            background-color: transparent;
        }

        body.dark-mode .message {
            border-color: rgba(64, 64, 64, 0.5);
        }

        body.dark-mode .bot-message {
            background-color: transparent;
            border-color: rgba(64, 64, 64, 0.5);
        }

        /* 修改用户消息样式 */
        .user-message {
            align-self: flex-end;
            background-color: transparent;
            color: #333;
            border: none;
        }

        /* 深色模式下的用户消息样式 */
        body.dark-mode .user-message {
            color: #e0e0e0;
        }

        /* 代码块复制按钮样式 */
        .code-container .copy-btn {
            margin-top: 0.25rem;
        }

        /* 修改相关提问样式 */
        .related-questions {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            padding-left: 0.75rem;  /* 添加左侧缩进 */
        }

        .related-question-btn {
            text-align: left;
            padding: 0.3rem 0.5rem;
            background: transparent;  /* 移除背景色 */
            border: none;            /* 移除边 */
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: #2563eb;
            transition: opacity 0.2s;
            opacity: 0.8;
            width: fit-content;      /* 宽度适应内容 */
        }

        .related-question-btn:hover {
            opacity: 1;
            background-color: transparent;  /* 移除悬停背景色 */
            text-decoration: underline;     /* 添加下划线效果 */
        }

        body.dark-mode .related-question-btn {
            color: #93c5fd;
            background: transparent;
        }

        body.dark-mode .related-question-btn:hover {
            background-color: transparent;
        }

        /* 添加隐藏滚动条但保持功能的样式 */
        .chat-area, .history-list {
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }

        .chat-area::-webkit-scrollbar, 
        .history-list::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }

        /* 添加左侧布局样式 */
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* 新对按钮样式 */
        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: transparent;
            color: #000;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .new-chat-btn svg {
            width: 16px;
            height: 16px;
        }

        /* 深色模式适配 */
        body.dark-mode .new-chat-btn {
            color: #fff;
            border-color: #404040;
        }

        body.dark-mode .new-chat-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 修改导航栏标题样式 */
        .navbar-brand {
            font-size: 1.1rem;
            font-weight: bold;
            color: #000000;  /* 默认黑色 */
            margin-left: 0;
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
        }

        /* 深色模式下的标题颜色 */
        body.dark-mode .navbar-brand {
            color: #ffffff;  /* 深色模式下改为白色 */
        }

        /* 修改输入容器样式 */
        .input-container {
            width: 100%;
            display: flex;
            gap: 0.5rem;
            padding: 0;
            position: relative;
        }

        /* 修改发送按钮样式 */
        .send-btn {
            position: absolute;
            right: 32px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
            height: 24px;
            line-height: 24px;
        }

        .send-btn:hover {
            color: #000;
        }

        .send-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #666;
            background-color: transparent;
        }

        /* 深色模式适配 */
        body.dark-mode .send-btn {
            color: #999;
            opacity: 0.5;
        }

        body.dark-mode .send-btn:hover {
            color: #fff;
        }

        /* 添加消息头部样式 */
        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            background-color: #f5f5f5;
            border-radius: 0.6rem;
            width: fit-content;
        }

        /* AI助手消息头部样式 */
        .bot-message .message-header {
            margin-right: auto;
            margin-left: -20px;  /* 左移20px */
        }

        /* 用户消息头部样式 */
        .user-message .message-header {
            margin-left: auto;
            margin-right: -20px;  /* 右移20px */
            flex-direction: row-reverse;
        }

        /* 图标样式 */
        .message-header .icon {
            width: 18px;
            height: 18px;
            padding: 3px;
            background-color: #fff;
            border-radius: 50%;  /* 圆形图标 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* 深色模式适配 */
        body.dark-mode .message-header {
            background-color: #2d2d2d;
        }

        body.dark-mode .message-header .icon {
            background-color: #404040;
        }

        /* 消息内容样式 */
        .message {
            max-width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            animation: fadeIn 0.3s ease-in;
            font-size: 0.9rem;
            margin: 0.3rem 0;
            word-break: break-word;
            white-space: pre-wrap;
            border: none;
            margin-left: 1rem;
            margin-right: 1rem;
        }

        /* 深色模式适配 */
        body.dark-mode .message-header {
            background-color: #2d2d2d;
        }

        body.dark-mode .message-header .icon,
        body.dark-mode .message-header span {
            color: #60a5fa;  /* 深色模式下使用更亮的蓝色 */
        }

        /* 修改消息内容段落样式 */
        .message p {
            margin: 0;
            line-height: 1.4;
        }

        /* 修改加载提示样式 */
        .typing-indicator {
            margin-top: 0.5rem;
        }

        /* 修改操作按钮组样式 */
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.8rem;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .action-btn:hover {
            opacity: 1;
            color: #2563eb;
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* 深色模式适配 */
        body.dark-mode .action-btn {
            color: #999;
        }

        body.dark-mode .action-btn:hover {
            color: #60a5fa;
        }

        /* 分享菜单样式 */
        .share-menu {
            position: absolute;
            left: 0;           /* 与分享按钮左对齐 */
            top: 100%;         /* 显示在分享按钮下方 */
            margin-top: 8px;   /* 与分享按钮的间距 */
            background: white;
            padding: 0.4rem;
            border-radius: 0.6rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            z-index: 1000;
        }

        .share-options {
            display: flex;
            gap: 0.5rem;
        }

        .share-options button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            padding: 0.5rem;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 社交媒体图标样式 */
        .share-options button.wechat {
            background: linear-gradient(135deg, #3eb64b, #07C160);
        }

        .share-options button.weibo {
            background: linear-gradient(135deg, #ff5d5d, #E6162D);
        }

        .share-options button.qq {
            background: linear-gradient(135deg, #38b0e3, #12B7F5);
        }

        .share-options button svg {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        .share-options button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* 深色模式适配 */
        body.dark-mode .share-menu {
            background: #2d2d2d;
        }

        body.dark-mode .share-options button {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .share-options button:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="main-content">
            <!-- 顶部导航栏 -->
            <nav class="navbar">
                <div class="navbar-left">
                    <div class="navbar-brand">Lionsky</div>
                    <button class="new-chat-btn" id="newChatBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span>新对话</span>
                    </button>
                </div>
                <div class="nav-buttons">
                    <button class="settings-btn" id="historyBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 6h16M4 12h16M4 18h10"></path>
                        </svg>
                    </button>
                    <button class="settings-btn" id="darkModeToggle">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"></path>
                        </svg>
                    </button>
                    <button class="settings-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.987 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                </div>
            </nav>

            <!-- 聊天区域 -->
            <main class="chat-area" id="chatArea">
                <div class="message bot-message">
                    <div class="message-header">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="8"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span>AI助手</span>
                    </div>
                    <p>您好！请问有什么可以帮您？</p>
                </div>
            </main>

            <!-- 输入区域 -->
            <footer class="input-area">
                <div class="input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput"
                        placeholder="请输入..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendButton">发送</button>
                </div>
            </footer>
        </div>

        <!-- 历史记录侧边栏 -->
        <div class="history-sidebar" id="historySidebar">
            <div class="history-header">
                <h3>历史记录</h3>
                <button class="clear-history-btn" id="clearHistoryBtn">清空</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- 历史记项会动态添加到这里 -->
            </div>
        </div>
    </div>

    <script>
        // 在所有代码之前声明全局变量
        let chatHistory = [];
        let conversationHistory = [];

        // API 配置
        const API_KEY = 'sk-97bad85fbeaf47d2b087c88dc96a63df';
        const API_URL = 'https://api.deepseek.com/v1/chat/completions';

        document.addEventListener('DOMContentLoaded', () => {
            // 获取DOM元素
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatArea = document.getElementById('chatArea');
            const historyBtn = document.getElementById('historyBtn');
            const historySidebar = document.getElementById('historySidebar');
            const historyList = document.getElementById('historyList');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const newChatBtn = document.getElementById('newChatBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');

            // 绑定发送按钮点击事件
            sendButton.addEventListener('click', sendMessage);

            // 绑定回车发
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 历史记录按钮点击事件
            historyBtn.addEventListener('click', () => {
                historySidebar.classList.toggle('active');
            });

            // 点击外部关闭历史记录
            document.addEventListener('click', (e) => {
                if (!historySidebar.contains(e.target) && 
                    !historyBtn.contains(e.target)) {
                    historySidebar.classList.remove('active');
                }
            });

            // 深色模式切换
            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const darkMode = document.body.classList.contains('dark-mode');
                darkModeToggle.innerHTML = darkMode ? 
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>' : 
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
            });

            // 自动调整文框高度
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // 加载历史记录
            loadHistory();

            // 新对话按钮点击事件
            newChatBtn.addEventListener('click', () => {
                chatArea.innerHTML = `
                    <div class="message bot-message">
                        <div class="message-header">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="8"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg><span>AI助手</span></div><p>您好！请问有什么可以帮您？</p>
                    </div>`;
                
                // 清空当前对话历史
                conversationHistory = [];
                
                // 清空输入框
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // 关闭历史记录侧边栏
                historySidebar.classList.remove('active');
            });

            // 清空历史记录
            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有历史记录吗？')) {
                    chatHistory = [];
                    localStorage.removeItem('chatHistory');
                    updateHistoryList();
                }
            });
        });

        // 修改 sendMessage 函数
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = messageInput.value.trim();
            if (!message) return;

            try {
                // 禁用入和发送按钮
                sendButton.disabled = true;
                messageInput.disabled = true;

                // 添加用户消息
                addMessage(message, 'user-message');
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // 显示加载状态
                const loadingIndicator = showTypingIndicator();

                // 更新对话历史
                conversationHistory.push({
                    role: "user",
                    content: message
                });

                // 准备请求数据
                const requestData = {
                    model: "deepseek-chat",
                    messages: [...conversationHistory],
                    temperature: 0.7,
                    max_tokens: 2000,
                    stream: false
                };

                // 发送请求
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });

                // 移除加载状态
                loadingIndicator.remove();

                // 处理响应
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.choices?.[0]?.message?.content) {
                    const aiResponse = data.choices[0].message.content;
                    // 更新对话历
                    conversationHistory.push({
                        role: "assistant",
                        content: aiResponse
                    });
                    addMessage(aiResponse, 'bot-message', true);
                    saveToHistory(message, aiResponse);
                } else {
                    throw new Error('Invalid response format');
                }

            } catch (error) {
                console.error('API Error:', error);
                showError(error.message || '请求失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // 添加错误处理函数
        function handleApiError(error) {
            if (error.message.includes('401')) {
                return '认证失败，请检查 API 密钥';
            } else if (error.message.includes('429')) {
                return '请求过于频繁，请稍后再试';
            } else if (error.message.includes('503')) {
                return '务暂时不可请稍后重';
            }
            return '请求失败，请稍后重试';
        }

        // 改进误显示函数
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message bot-message';
            errorDiv.innerHTML = `
                <div class="error-message">
                    <span class="error-icon">⚠️</span>
                    <div>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatArea.appendChild(errorDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transition = 'opacity 0.3s';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        // 添加重试机制
        let retryCount = 0;
        const MAX_RETRIES = 3;

        async function fetchWithRetry(url, options) {
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        retryCount = 0;
                        return response;
                    }
                } catch (error) {
                    if (i === MAX_RETRIES - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
            throw new Error('最大重试次数已达到');
        }

        // 更新生成相关问题的函数
        function generateRelatedQuestions(content) {
            // 提取主题词
            let topic = content.split(/[.,!?，。！？\s]/)[0];
            
            // 如果主题词太长，提取更短的关键词
            if (topic.length > 10) {
                const keywords = content.match(/[一-龥]{2,6}/g);
                if (keywords && keywords.length > 0) {
                    topic = keywords[0];
                }
            }
            
            // 根内容类型生成相关问题
            let questions = [];
            
            // 如果是解释性内容
            if (content.includes('是什么') || content.includes('解释') || content.includes('定义')) {
                questions = [
                    `${topic}有哪些具体应用？`,
                    `${topic}的主要特点是什么？`,
                    `${topic}与其他类似概念有什么区别？`
                ];
            }
            // 如果是应用或用途
            else if (content.includes('应用') || content.includes('用途') || content.includes('使用')) {
                questions = [
                    `${topic}的实现原理是什么？`,
                    `${topic}有什么优缺点？`,
                    `如何优化${topic}的效果？`
                ];
            }
            // 如果是方法或步骤
            else if (content.includes('怎么') || content.includes('如何') || content.includes('方法')) {
                questions = [
                    `${topic}过程中有什么注意事项？`,
                    `有哪些见的${topic}问题？`,
                    `如何提高${topic}的效率？`
                ];
            }
            // 如是优缺点或较
            else if (content.includes('优点') || content.includes('缺点') || content.includes('区别')) {
                questions = [
                    `如何克服${topic}的缺点？`,
                    `${topic}在实际中如何应用？`,
                    `有什么改进${topic}的方法？`
                ];
            }
            // 如果是问题或错误
            else if (content.includes('题') || content.includes('错误') || content.includes('异常')) {
                questions = [
                    `${topic}的最佳解决方案什么？`,
                    `如何预防${topic}？`,
                    `还有哪些类似的${topic}？`
                ];
            }
            // 默认问题
            else {
                questions = [
                    `${topic}具体应用场有哪些？`,
                    `${topic}的实现原理是什么？`,
                    `${topic}未来的发展趋势如何？`
                ];
            }
            
            return questions;
        }

        // 添加打字机效果函数
        function typeWriter(element, text, index = 0) {
            if (index < text.length) {
                const char = text.charAt(index);
                if (char === '\n') {
                    element.innerHTML += '<br>';
                } else {
                    element.innerHTML += char;
                }
                index++;
                // 调整打字速度（数字越小越快）
                setTimeout(() => typeWriter(element, text, index), 30);
            }
        }

        // 修改 addMessage 函数
        function addMessage(content, className, isMarkdown = false, useTypeWriter = true) {  // 添加参数控制是否使用打字机效果
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            
            // 添加消息头部
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            if (className === 'bot-message') {
                headerDiv.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="8"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg><span>AI助手</span>`;
            } else {
                headerDiv.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="8"/>
                        <circle cx="12" cy="8" r="3"/>
                        <path d="M12 11v3"/>
                    </svg><span>用户</span>`;
            }
            messageDiv.appendChild(headerDiv);
            
            // 添加消息内容
            const contentP = document.createElement('p');
            if (className === 'bot-message') {
                // 移除可能的 markdown 标记
                const cleanContent = content.replace(/^#+\s+/gm, '');
                const formattedContent = cleanContent.split('\n').map(paragraph => {
                    if (paragraph.trim() === '') return paragraph;
                    return '　　' + paragraph;
                }).join('\n');
                
                if (useTypeWriter) {
                    // 使用打字机效果显示内容
                    contentP.innerHTML = '';
                    messageDiv.appendChild(contentP);
                    chatArea.appendChild(messageDiv);
                    typeWriter(contentP, formattedContent);
                } else {
                    // 直接显示全部内容
                    contentP.innerHTML = formattedContent;
                    messageDiv.appendChild(contentP);
                    chatArea.appendChild(messageDiv);
                }
                
                // 添加操作按钮
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // 复制按钮
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn';
                copyBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <span>复制</span>
                `;
                copyBtn.onclick = () => copyMessage(content);
                
                // 刷新按钮
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'action-btn';
                refreshBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    <span>重新生成</span>
                `;
                refreshBtn.onclick = () => regenerateResponse();
                
                // 分享按钮
                const shareBtn = document.createElement('button');
                shareBtn.className = 'action-btn';
                shareBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    <span>分享</span>
                `;
                shareBtn.onclick = (event) => shareMessage(content, event);
                
                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(refreshBtn);
                actionsDiv.appendChild(shareBtn);
                messageDiv.appendChild(actionsDiv);
            } else {
                contentP.innerHTML = content;
                messageDiv.appendChild(contentP);
                chatArea.appendChild(messageDiv);
            }
            
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 复制消息内容
        async function copyMessage(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('复制成');
            } catch (err) {
                showToast('复制失');
            }
        }

        // 复制代码内容
        async function copyCode(code) {
            try {
                await navigator.clipboard.writeText(code);
                showToast('代码复制成功');
            } catch (err) {
                showToast('复制失败');
            }
        }

        // 显示提示信息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 0.25rem;
                z-index: 1000;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // 修改显示加载状态函数
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message bot-message typing-indicator';
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85rem; color: #666;">正在加载，请您耐心等待</span>
                    <div style="display: flex; gap: 4px;">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatArea.appendChild(indicator);
            chatArea.scrollTop = chatArea.scrollHeight;
            return indicator;
        }

        // 保存对话到历史记录
        function saveToHistory(userMessage, botMessage) {
            if (!userMessage || !botMessage) return;  // 添加空值检查
            
            try {
                const timestamp = new Date().toLocaleString();
                const conversation = {
                    id: Date.now(),
                    timestamp,
                    userMessage: String(userMessage),  // 确保是字符串
                    botMessage: String(botMessage)     // 确保是字符串
                };
                
                chatHistory.unshift(conversation);
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(0, 20);
                }
                
                updateHistoryList();
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            } catch (error) {
                console.error('保存历史记录失败:', error);
            }
        }

        // 修改 updateHistoryList 函数，添加错误处理和内容检查
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;  // 添加空值检查
            
            try {
                const historyContent = chatHistory.map(chat => {
                    // 确保 userMessage 存在且是字符串
                    const message = typeof chat.userMessage === 'string' ? chat.userMessage : '';
                    const truncatedMessage = message.substring(0, 30);
                    const ellipsis = message.length > 30 ? '...' : '';
                    
                    return `
                        <div class="history-item" data-id="${chat.id}">
                            <div class="history-content">${truncatedMessage}${ellipsis}</div>
                        </div>
                    `;
                }).join('');

                historyList.innerHTML = historyContent;

                // 添加点击事件
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        try {
                            const chatId = parseInt(item.dataset.id);
                            const chat = chatHistory.find(c => c.id === chatId);
                            if (chat && chat.userMessage && chat.botMessage) {
                                const chatArea = document.getElementById('chatArea');
                                chatArea.innerHTML = '';
                                addMessage(chat.userMessage, 'user-message', false, false);  // 不使用打字机效果
                                addMessage(chat.botMessage, 'bot-message', true, false);     // 不使用打字机效果
                                document.getElementById('historySidebar').classList.remove('active');
                            }
                        } catch (error) {
                            console.error('历史记录点击处理错误:', error);
                        }
                    });
                });
            } catch (error) {
                console.error('更新历史记录列表错误:', error);
            }
        }

        // 加载历史记录
        function loadHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                chatHistory = JSON.parse(saved);
                updateHistoryList();
            }
        }

        // 修改重新生成功能
        async function regenerateResponse() {
            try {
                // 获取最后一次用户消息和AI回答
                if (conversationHistory.length < 2) return;
                
                // 保存用户最后一次提问
                const lastUserMessage = conversationHistory[conversationHistory.length - 2];
                if (lastUserMessage.role !== 'user') return;

                // 显示加载状态
                const loadingIndicator = showTypingIndicator();

                // 移除上一次的AI回答
                const lastMessage = chatArea.lastElementChild;
                if (lastMessage && lastMessage.classList.contains('bot-message')) {
                    lastMessage.remove();
                    conversationHistory.pop(); // 移除上一次的回答
                }

                // 重新发送请求
                const requestData = {
                    model: "deepseek-chat",
                    messages: [...conversationHistory],
                    temperature: 0.7,
                    max_tokens: 2000,
                    stream: false
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });

                loadingIndicator.remove();

                if (!response.ok) {
                    throw new Error('重新生成失败，请稍后重试');
                }

                const data = await response.json();
                if (data.choices?.[0]?.message?.content) {
                    const aiResponse = data.choices[0].message.content;
                    conversationHistory.push({
                        role: "assistant",
                        content: aiResponse
                    });
                    addMessage(aiResponse, 'bot-message', true);
                    
                    // 更新历记录
                    if (chatHistory.length > 0) {
                        const lastHistory = chatHistory[0];
                        lastHistory.botMessage = aiResponse;
                        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                        updateHistoryList();
                    }
                }
            } catch (error) {
                console.error('重新生成错误:', error);
                showError(error.message);
            }
        }

        // 修改分享功能
        function shareMessage(content, event) {  // 添加 event 参数
            // 获取分享按钮的父元素（message-actions）
            const actionsDiv = event.currentTarget.parentElement;
            
            // 移除可能已存在的分享菜单
            const existingMenu = document.querySelector('.share-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // 创建分享菜单
            const shareMenu = document.createElement('div');
            shareMenu.className = 'share-menu';
            shareMenu.innerHTML = `
                <div class="share-options">
                    <button class="wechat" onclick="shareToWeChat('${encodeURIComponent(content)}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 11.9C4 7.9 7.4 4.7 11.4 4.7C15.4 4.7 18.8 7.9 18.8 11.9C18.8 15.9 15.4 19.1 11.4 19.1C10.1 19.1 8.8 18.8 7.7 18.2L4 19.9L5.7 16.2C4.9 15 4.4 13.5 4.4 11.9"/>
                        </svg>
                    </button>
                    <button class="weibo" onclick="shareToWeibo('${encodeURIComponent(content)}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.9 14.5C20.9 18.5 16.5 21.7 11.1 21.7C5.7 21.7 1.3 18.5 1.3 14.5C1.3 10.5 5.7 7.3 11.1 7.3"/>
                            <path d="M15.7 2.3C17.7 2.3 19.3 3.9 19.3 5.9C19.3 7.9 17.7 9.5 15.7 9.5"/>
                        </svg>
                    </button>
                    <button class="qq" onclick="shareToQQ('${encodeURIComponent(content)}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C17.5 22 22 17.5 22 12C22 6.5 17.5 2 12 2Z"/>
                            <path d="M12 6V12L16 14"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // 添加到分享按钮所在的 message-actions 中
            actionsDiv.appendChild(shareMenu);
            
            // 点击外部关闭分享菜单
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!shareMenu.contains(e.target) && !event.currentTarget.contains(e.target)) {
                        shareMenu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }

        // 添加分享到各平台的功能
        function shareToWeChat(content) {
            // 实现微信分享逻辑
            showToast('微信分享功能开发中...');
        }

        function shareToWeibo(content) {
            // 实现微博分享逻辑
            const url = `http://service.weibo.com/share/share.php?url=${location.href}&title=${content}`;
            window.open(url, '_blank');
        }

        function shareToQQ(content) {
            // 实现QQ分享逻辑
            const url = `http://connect.qq.com/widget/shareqq/index.html?url=${location.href}&title=AI助手对话&summary=${content}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html> 